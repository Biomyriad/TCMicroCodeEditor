<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>MicroCode Editor</title>
  <link rel="stylesheet" href="styles.css">
  <script src="main.js"></script>
  <script src="opCodeListbox.js" defer></script>
  <script src="ctrlLineListbox.js" defer></script>
  <script src="mStateListbox.js" defer></script>
  <script src="ctrlLineStateListbox.js" defer></script>
  <script src="saveLoadFileData.js" defer></script>
  <!-- started 6-22-24 -->
  <style>
    
    
  </style>

</head>
<body onload="initApp()">
  <div id="option-bar">
    <div>
      <label>State:</label>
      <button onclick="saveStateToFile()">Save</button>
      <button onclick="loadStateFromFile()">Load</button>
    </div>
    <div>
      <label>Export to bin:</label>
      <button>Save</button>
    </div>
  </div>
  
  <div style="margin-bottom: 20px; margin-top: 20px;">
    <button onclick="TEST()" style="width: 57px; height: 57px; margin-right: 30px;">TEST</button>
    <button onclick="TEST2()" style="width: 57px; height: 57px;">TEST2</button>
  </div>
  
  
  <div id="content">
    <div>   <!-- OP Code List -->
      <div class="scroll-box" id="opcode-listbox"></div>
      <div style="margin-bottom: 5px;">
        <input type="text" id="new-op-code" style="width: 47px;" autocomplete="off">
        <input type="text" id="new-op-mnem" style="width: 125PX;" autocomplete="off">
        <input type="text" id="update-op-code" style="width: 47px;" autocomplete="off">
      </div>
      <div style="display: flex; justify-content: center; gap: 5px">
        <button onclick="opCodeLB.saveEntry()" style="width: 57px;">Save</button>
        <button onclick="opCodeLB.deleteEntry()" style="width: 57px;">Delete</button>
      </div>    
    </div>
    
    <div>
      <div class="scroll-box" id="opcode-statelist"></div>
      <div style="display: flex; justify-content: center; gap: 5px;">
        <button onclick="mStateLB.addState()">Add</button>
        <button onclick="mStateLB.removeState()">Remove</button>
      </div>
    </div>
  </div>
  
  <div id="popup">
    <div class="scroll-box" id="ctrllines-available"></div>
    <div class="" id="ctrllines-controls">
      <div id="ctrlform">
        <input type="number" id="ctrlform-bit" placeholder="Bit">
        <input type="text" id="ctrlform-name" placeholder="Name">
        <input type="text" id="ctrlform-group" placeholder="Group">
        <input type="text" id="ctrlform-overridecolor" placeholder="color">
        <div style="display: flex; justify-content: center; gap: 5px;">
          <button onclick="ctrlLineLB.saveEntry()">Save</button>
          <button onclick="ctrlLineLB.deleteEntry()">Delete</button>
        </div>
      </div>
      <div id="actionCtrls">
        <button onclick="ctrlLineStateLB.addCtrlToOpState()">=></button>
        <button onclick="ctrlLineStateLB.removeCtrlFromOpState()"><=</button>
        <button onclick="ctrlLineStateLB.deselectCtrl()">deSel</button>
      </div>
    </div>
    <div class="scroll-box" id="ctrllines-selected"></div>
  </div>

  <script>
    
    // --------- ONLOAD ------------
    function initApp() {
      loadState()
      opCodeLB.refresh()
      ctrlLineLB.refresh()
    }
//---------- TEST FUNCTIONS ---------
    function TEST() {

      //alert(2**3) // 2^pos
      
      // highest bit
      let clItem = ctrlLines.clList
      let maxBit = 0
      for(i in clItem) {
        if(clItem[i].bit > maxBit) maxBit = clItem[i].bit
      }
      maxBit = parseInt(maxBit)
      
      // maxBit: max bits
      let numBytes = Math.ceil((maxBit+1)/8)
      let numFiles = Math.ceil(numBytes/8)
      
      //alert(maxBit + ' ' + numBytes + ' ' + numFiles)
      
      let opItem = opCodes.opCodeList
      let maxStates = 0
      let maxOpcode = 0
      for(i in opItem) {
        if(Number('0x' + opItem[i].code) > maxOpcode) maxOpcode = Number('0x' + opItem[i].code)
        if(opItem[i].mStateList.length > maxStates) maxStates = opItem[i].mStateList.length
      }
      
      alert(maxStates + ' - ' + maxOpcode)
      
      let bitPos = 16
      let byteIdx = Math.floor(bitPos/8)
      let bitIdx = bitPos - (byteIdx*8)
      
      //alert(byteIdx + ' - ' + bitIdx)
      
    }
    function TEST2() {
      //localStorage.clear()
      opCodes.opCodeList.sort((a,b) => {
        console.log(Number('0x'+ a.code) + ' - ' + Number('0x' + b.code))
        if(Number('0x'+ a.code) > Number('0x' + b.code)) return 1
        return -1
      })
      
      opCodeLB.refresh()
    }


  </script>

</body>
</html>