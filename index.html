<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>MicroCode Editor</title>
  <link rel="stylesheet" href="styles.css">
  <script src="main.js"></script>
  <script src="opCodeListbox.js" defer></script>
  <script src="ctrlLineListbox.js" defer></script>
  <script src="mStateListbox.js" defer></script>
  <script src="saveLoadFileData.js" defer></script>
  <!-- started 6-22-24 -->
  <style>
    
    
  </style>

</head>
<body onload="initApp()">
  <div id="option-bar">
    <div>
      <label>State:</label>
      <button onclick="saveStateToFile()">Save</button>
      <button onclick="loadStateFromFile()">Load</button>
    </div>
    <div>
      <label>Export to bin:</label>
      <button>Save</button>
    </div>
  </div>
  
  <div style="margin-bottom: 20px; margin-top: 20px;">
    <button onclick="TEST()" style="width: 57px; height: 57px; margin-right: 30px;">TEST</button>
    <button onclick="TEST2()" style="width: 57px; height: 57px;">TEST2</button>
  </div>
  
  
  <div id="content">
    <div>   <!-- OP Code List -->
      <div class="scroll-box" id="opcode-listbox"></div>
      <div style="margin-bottom: 5px;">
        <input type="text" id="new-op-code" style="width: 47px;" autocomplete="off">
        <input type="text" id="new-op-mnem" style="width: 125PX;" autocomplete="off">
        <input type="text" id="update-op-code" style="width: 47px;" autocomplete="off">
      </div>
      <div style="display: flex; justify-content: center; gap: 5px">
        <button onclick="opCodeLB.saveEntry()" style="width: 57px;">Save</button>
        <button onclick="opCodeLB.deleteEntry()" style="width: 57px;">Delete</button>
      </div>    
    </div>
    
    <div>
      <div class="scroll-box" id="opcode-statelist"></div>
      <div style="display: flex; justify-content: center; gap: 5px;">
        <button onclick="mStateLB.addState()">Add</button>
        <button onclick="mStateLB.removeState()">Remove</button>
      </div>
    </div>
  </div>
  
  <div id="popup">
    <div class="scroll-box" id="ctrllines-available"></div>
    <div class="" id="ctrllines-controls">
      <div id="ctrlform">
        <input type="number" id="ctrlform-bit" placeholder="Bit">
        <input type="text" id="ctrlform-name" placeholder="Name">
        <input type="text" id="ctrlform-group" placeholder="Group">
        <input type="text" id="ctrlform-overridecolor" placeholder="color">
        <div style="display: flex; justify-content: center; gap: 5px;">
          <button onclick="ctrlLineLB.saveEntry()">Save</button>
          <button onclick="ctrlLineLB.deleteEntry()">Delete</button>
        </div>
      </div>
      <div id="actionCtrls">
        <button onclick="ctrlLineStateLB.addCtrlToOpState()">=></button>
        <button onclick="ctrlLineStateLB.removeCtrlFromOpState()"><=</button>
        <button onclick="ctrlLineStateLB.deselectCtrl()">deSel</button>
      </div>
    </div>
    <div class="scroll-box" id="ctrllines-selected"></div>
  </div>

  <script>



// ----------- ctrl lines ---------

var ctrlLineStateLB = {}
ctrlLineStateLB.listbox = document.getElementById('ctrllines-selected')
ctrlLineStateLB.selected = null

ctrlLineStateLB.addCtrlToOpState = () => {
  if(mStateLB.selectedOpCode == null ||
     mStateLB.selectedStateIdx == null ||
     ctrlLineLB.selectedUid == null ) return
  
  let selectedCtrlUID = ctrlLineLB.selectedUid
  let selectedList = mStateLB.selectedOpCode.mStateList[mStateLB.selectedStateIdx]
  for(i in selectedList) {
    if(selectedList[i] == selectedCtrlUID) return
  }
  
  selectedList.push(selectedCtrlUID)
  ctrlLineLB.selectedUid = null
  ctrlLineStateLB.selected = null
  saveState()
  mStateLB.refresh()
  ctrlLineStateLB.refresh()
  
}

ctrlLineStateLB.removeCtrlFromOpState = () => {
  if(mStateLB.selectedOpCode == null ||
     mStateLB.selectedStateIdx == null ||
     ctrlLineStateLB.selected == null ) return
  
  let selectedCtrlUID = ctrlLineStateLB.selected
  let selectedList = mStateLB.selectedOpCode.mStateList[mStateLB.selectedStateIdx]
  for(i in selectedList) {
    if(selectedList[i] == selectedCtrlUID) {
      selectedList.splice(i, 1)
    }
  }
  
  ctrlLineStateLB.selected = null
  saveState()
  mStateLB.refresh()
  ctrlLineStateLB.refresh()
}

ctrlLineStateLB.deselectCtrl = () => {
  ctrlLineLB.selectedUid = null
  ctrlFormBitTbx.value = ''
  ctrlFormNameTbx.value = ''
  ctrlFormGroupTbx.value = ''
  ctrlFormOverrideColorTbx.value = ''
}

ctrlLineStateLB.createEntryEle = (ctrlLineUid) => {
  let ele = document.createElement("div")
  //let tx1 = document.createElement("span")
  //let tx2 = document.createElement("span")
  let tx3 = document.createElement('span')
  //let tx4 = document.createElement("span")
  //let tx5 = document.createElement("span")
  

  ele.addEventListener("click", ctrlLineStateLB.entryClickHandler);
  ele.id = "ctrllineselected-" + ctrlLineUid
  //tx1.innerText = bit
  //tx2.innerText = ' - '
  tx3.innerText = ctrlLines.containsCode(ctrlLineUid).name//name
  //tx4.innerText = ' - '
  //tx5.innerText = group
  //ele.appendChild(tx1)
  //ele.appendChild(tx2)
  ele.appendChild(tx3)
  //ele.appendChild(tx4)
  //ele.appendChild(tx5)

  return ele
}

ctrlLineStateLB.entryClickHandler = (event) => {
  ctrlLineStateLB.selected = event.currentTarget.id.split('-')[1]
}
  
ctrlLineStateLB.refresh = () => {
  if(mStateLB.selectedOpCode != null && 
     mStateLB.selectedStateIdx != null) {
  
    ctrlLineStateLB.selected = null
    let selectedList = mStateLB.selectedOpCode.mStateList[mStateLB.selectedStateIdx]
    ctrlLineStateLB.listbox.replaceChildren()
    for(i in selectedList) {
      ctrlLineStateLB.listbox.appendChild(
        ctrlLineStateLB.createEntryEle(selectedList[i])
      )
    }
  } else {
    ctrlLineStateLB.listbox.replaceChildren()
  }
}

    
    // --------- ONLOAD ------------
    function initApp() {
      loadState()
      opCodeLB.refresh()
      ctrlLineLB.refresh()
      
      //mStateLB.listbox.appendChild(mStateLB.createEntryEle())
    }
//-------------------
    function TEST() {
      //ctrlLines.clList
      //opCodes.opCodeList
      //alert(2**3) // 2^pos
      
      // highest bit
      let clItem = ctrlLines.clList
      let maxBit = 0
      for(i in clItem) {
        if(clItem[i].bit > maxBit) maxBit = clItem[i].bit
      }
      maxBit = parseInt(maxBit)
      
      // maxBit: max bits
      let numBytes = Math.ceil((maxBit+1)/8)
      let numFiles = Math.ceil(numBytes/8)
      
      //alert(maxBit + ' ' + numBytes + ' ' + numFiles)
      
      let opItem = opCodes.opCodeList
      let maxStates = 0
      for(i in opItem) {
        if(opItem[i].mStateList.length > maxStates) maxStates = opItem[i].mStateList.length
      }
      
      //alert(maxStates)
      
      let bitPos = 16
      let byteIdx = Math.floor(bitPos/8)
      let bitIdx = bitPos - (byteIdx*8)
      
      alert(byteIdx + ' - ' + bitIdx)
    }
    function TEST2() {
      loadFile(alert)
      
     //saveTxtFile( [1,22,32,56,74], "helo.xyz")
      
    }


  </script>

</body>
</html>